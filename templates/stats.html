{% extends "base.html" %}
{% import 'components.html' as components %}

{% block title %}
YouTube Thumbs - {% if current_tab == 'overview' %}Statistics Overview{% elif current_tab == 'analytics' %}Analytics{% elif current_tab == 'api' %}API & Queue{% elif current_tab == 'categories' %}Categories & Duration{% elif current_tab == 'discovery' %}Discovery{% endif %}
{% endblock %}

{% block styles %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/stats.css') }}">
<meta http-equiv="refresh" content="300"> <!-- Auto-refresh every 5 minutes -->
{% endblock %}

{% block container_content %}
<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
    <h1>Statistics Dashboard</h1>
    <div style="font-size: 0.65em; color: #64748b;">Auto-refresh: 5min</div>
</div>

{% block tabs %}
{{ components.tabs([
    {'id': 'overview', 'label': 'Overview', 'icon': 'üìä', 'url': ingress_path + '/stats'},
    {'id': 'analytics', 'label': 'Analytics', 'icon': 'üìà', 'url': ingress_path + '/stats?tab=analytics'},
    {'id': 'api', 'label': 'API & Queue', 'icon': 'üîß', 'url': ingress_path + '/stats?tab=api'},
    {'id': 'categories', 'label': 'Categories', 'icon': 'üìÅ', 'url': ingress_path + '/stats?tab=categories'},
    {'id': 'discovery', 'label': 'Discovery', 'icon': 'üîç', 'url': ingress_path + '/stats?tab=discovery'}
], active_tab=current_tab) }}
{% endblock %}

<div class="content">
    {% if current_tab == 'overview' %}
    <!-- ==================== OVERVIEW TAB ==================== -->

    <!-- Summary Metrics -->
    {{ components.stat_grid([
        {'value': summary.total_videos, 'label': 'Total Videos'},
        {'value': summary.total_plays, 'label': 'Total Plays'},
        {'value': summary.liked, 'label': 'Liked üëç', 'link': ingress_path + '/stats/liked'},
        {'value': summary.disliked, 'label': 'Disliked üëé', 'link': ingress_path + '/stats/disliked'},
        {'value': summary.skipped, 'label': 'Skipped ‚è≠Ô∏è'},
        {'value': summary.unrated, 'label': 'Unrated'},
        {'value': '%.1f%%'|format(summary.like_percentage), 'label': 'Like Rate'}
    ]) }}

    <!-- Most Played Videos -->
    {% set most_played_items = [] %}
    {% for video in most_played[:10] %}
        {% set _ = most_played_items.append({
            'primary': video.title,
            'secondary': video.artist,
            'value': video.play_count ~ ' plays'
        }) %}
    {% endfor %}
    {{ components.list_card('Most Played Videos', most_played_items) }}

    <!-- Top Channels -->
    {% set channel_items = [] %}
    {% for channel in top_channels[:10] %}
        {% set _ = channel_items.append({
            'primary': channel.name,
            'value': channel.play_count ~ ' plays'
        }) %}
    {% endfor %}
    {{ components.list_card('Top Channels', channel_items) }}

    <!-- Recent Activity -->
    {% set recent_items = [] %}
    {% for item in recent_activity[:10] %}
        {% set _ = recent_items.append({
            'primary': item.title,
            'secondary': item.artist ~ ' ‚Ä¢ ' ~ item.played_at,
            'value': 'üëç' if item.rating == 1 else ('üëé' if item.rating == -1 else '‚è≠Ô∏è')
        }) %}
    {% endfor %}
    {{ components.list_card('Recent Activity', recent_items) }}

    {% elif current_tab == 'analytics' %}
    <!-- ==================== ANALYTICS TAB ==================== -->

    <div class="card">
        <h2>Usage Patterns</h2>

        <!-- Time-based Analytics -->
        <div class="stat-cards-grid">
            <div class="stat-card">
                <div class="stat-value">{{ analytics.peak_hour.hour if analytics.peak_hour else 'N/A' }}</div>
                <div class="stat-label">Peak Hour</div>
                <div class="stat-sublabel">{{ analytics.peak_hour.count if analytics.peak_hour else 0 }} plays</div>
            </div>
            <div class="stat-card">
                <div class="stat-value">{{ analytics.peak_day if analytics.peak_day else 'N/A' }}</div>
                <div class="stat-label">Peak Day</div>
            </div>
            <div class="stat-card">
                <div class="stat-value">{{ analytics.avg_daily_plays }}</div>
                <div class="stat-label">Avg Daily Plays</div>
            </div>
            <div class="stat-card">
                <div class="stat-value">{{ analytics.avg_daily_ratings }}</div>
                <div class="stat-label">Avg Daily Ratings</div>
            </div>
        </div>

        <!-- Activity Heatmap -->
        <h3 style="margin-top: 30px;">Weekly Activity Heatmap</h3>
        <div class="heatmap-container">
            <div class="heatmap-header">
                <div class="heatmap-header-spacer"></div>
                <div class="heatmap-hour-labels">
                    {% for hour in range(24) %}
                    <div>{{ hour }}</div>
                    {% endfor %}
                </div>
            </div>

            {% set days = ['Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat', 'Sun'] %}
            {% for day_idx, day in enumerate(days) %}
            <div class="heatmap-grid">
                <div class="heatmap-day-label">{{ day }}</div>
                {% for hour in range(24) %}
                    {% set count = analytics.heatmap_data.get((day_idx, hour), 0) if analytics.heatmap_data else 0 %}
                    {% set intensity = min(5, (count / max(1, analytics.max_hour_count if analytics.max_hour_count else 1)) * 5) | int %}
                    <div class="heat-cell heat-{{ intensity }}"
                         title="{{ day }} {{ hour }}:00 - {{ count }} plays"></div>
                {% endfor %}
            </div>
            {% endfor %}
        </div>

        <!-- Rating Distribution -->
        <h3 style="margin-top: 30px;">Rating Distribution by Day</h3>
        <div class="bar-chart">
            {% for day in analytics.daily_ratings[:7] %}
            <div class="bar-row">
                <div class="bar-label">{{ day.date }}</div>
                <div class="bar-container">
                    <div class="bar-fill bar-success"
                         style="width: {{ (day.liked / max(day.total, 1) * 100) | round }}%">
                        {{ day.liked }} üëç
                    </div>
                </div>
                <div class="bar-container">
                    <div class="bar-fill bar-danger"
                         style="width: {{ (day.disliked / max(day.total, 1) * 100) | round }}%">
                        {{ day.disliked }} üëé
                    </div>
                </div>
            </div>
            {% endfor %}
        </div>
    </div>

    {% elif current_tab == 'api' %}
    <!-- ==================== API & QUEUE TAB ==================== -->

    <!-- API Stats -->
    <div class="card">
        <h2>YouTube API Usage</h2>
        <div class="stat-cards-grid">
            <div class="stat-card">
                <div class="stat-value">{{ api_stats.total_api_calls }}</div>
                <div class="stat-label">Total API Calls</div>
            </div>
            <div class="stat-card">
                <div class="stat-value">{{ api_stats.successful_calls }}</div>
                <div class="stat-label">Successful</div>
            </div>
            <div class="stat-card">
                <div class="stat-value">{{ api_stats.failed_calls }}</div>
                <div class="stat-label">Failed</div>
            </div>
            <div class="stat-card">
                <div class="stat-value">{{ '%.1f%%'|format(api_stats.success_rate) }}</div>
                <div class="stat-label">Success Rate</div>
            </div>
        </div>

        <!-- Common Errors -->
        {% if api_stats.common_errors %}
        <h3 style="margin-top: 20px;">Common API Errors</h3>
        {% set headers = [
            {'label': 'Error', 'class': 'col-error'},
            {'label': 'Count', 'class': 'col-count'}
        ] %}
        {% set rows = [] %}
        {% for error in api_stats.common_errors %}
            {% set _ = rows.append({
                'cells': [
                    {'value': error.error[:100]},
                    {'value': error.count}
                ]
            }) %}
        {% endfor %}
        {{ components.data_table(headers, rows, sortable=false) }}
        {% endif %}
    </div>

    <!-- Queue Stats -->
    <div class="card" style="margin-top: 20px;">
        <h2>Queue Activity</h2>

        <!-- Queue Metrics -->
        <div class="stat-cards-grid">
            <div class="stat-card">
                <div class="stat-value">{{ queue_stats.total_queued }}</div>
                <div class="stat-label">Total Queued</div>
            </div>
            <div class="stat-card">
                <div class="stat-value">{{ queue_stats.pending }}</div>
                <div class="stat-label">Pending</div>
            </div>
            <div class="stat-card">
                <div class="stat-value">{{ queue_stats.processing }}</div>
                <div class="stat-label">Processing</div>
            </div>
            <div class="stat-card">
                <div class="stat-value">{{ queue_stats.completed }}</div>
                <div class="stat-label">Completed</div>
            </div>
            <div class="stat-card">
                <div class="stat-value">{{ queue_stats.failed }}</div>
                <div class="stat-label">Failed</div>
            </div>
            <div class="stat-card">
                <div class="stat-value">{{ '%.1f%%'|format(queue_stats.completion_rate) }}</div>
                <div class="stat-label">Completion Rate</div>
            </div>
        </div>

        <!-- Recent Queue Items -->
        {% if queue_stats.recent_items %}
        <h3 style="margin-top: 20px;">Recent Queue Activity</h3>
        {% set recent_queue_items = [] %}
        {% for item in queue_stats.recent_items[:10] %}
            {% set status_badge = '‚úÖ' if item.status == 'completed' else ('‚ùå' if item.status == 'failed' else '‚è≥') %}
            {% set _ = recent_queue_items.append({
                'primary': item.action ~ ' - ' ~ (item.video_title[:50] if item.video_title else 'Unknown'),
                'secondary': item.created_at,
                'value': status_badge
            }) %}
        {% endfor %}
        {{ components.list_card('', recent_queue_items) }}
        {% endif %}
    </div>

    {% elif current_tab == 'categories' %}
    <!-- ==================== CATEGORIES TAB ==================== -->

    <div class="card">
        <h2>Content Categories</h2>

        <!-- Category Distribution -->
        {% if category_stats %}
        <div class="bar-chart">
            {% for cat in category_stats[:10] %}
            <div class="bar-row">
                <div class="bar-label">{{ cat.category or 'Unknown' }}</div>
                <div class="bar-container">
                    <div class="bar-fill"
                         style="width: {{ (cat.count / max(category_stats[0].count if category_stats else 1, 1) * 100) | round }}%">
                        {{ cat.count }} videos
                    </div>
                </div>
            </div>
            {% endfor %}
        </div>
        {% else %}
        {{ components.empty_state('No category data available') }}
        {% endif %}
    </div>

    <!-- Duration Stats -->
    <div class="card" style="margin-top: 20px;">
        <h2>Video Duration Analysis</h2>

        <div class="stat-cards-grid">
            <div class="stat-card">
                <div class="stat-value">{{ duration_stats.avg_duration }}s</div>
                <div class="stat-label">Avg Duration</div>
            </div>
            <div class="stat-card">
                <div class="stat-value">{{ duration_stats.total_watch_time }}h</div>
                <div class="stat-label">Total Watch Time</div>
            </div>
            <div class="stat-card">
                <div class="stat-value">{{ duration_stats.shortest }}s</div>
                <div class="stat-label">Shortest Video</div>
            </div>
            <div class="stat-card">
                <div class="stat-value">{{ duration_stats.longest }}s</div>
                <div class="stat-label">Longest Video</div>
            </div>
        </div>

        <!-- Duration Distribution -->
        <h3 style="margin-top: 20px;">Duration Distribution</h3>
        <div class="bar-chart">
            {% for range in duration_stats.distribution %}
            <div class="bar-row">
                <div class="bar-label">{{ range.label }}</div>
                <div class="bar-container">
                    <div class="bar-fill"
                         style="width: {{ (range.count / max(duration_stats.max_count if duration_stats.max_count else 1, 1) * 100) | round }}%">
                        {{ range.count }} videos
                    </div>
                </div>
            </div>
            {% endfor %}
        </div>
    </div>

    {% elif current_tab == 'discovery' %}
    <!-- ==================== DISCOVERY TAB ==================== -->

    <div class="card">
        <h2>Content Discovery</h2>

        <!-- Discovery Metrics -->
        <div class="stat-cards-grid">
            <div class="stat-card">
                <div class="stat-value">{{ discovery_stats.unique_artists }}</div>
                <div class="stat-label">Unique Artists</div>
            </div>
            <div class="stat-card">
                <div class="stat-value">{{ discovery_stats.unique_channels }}</div>
                <div class="stat-label">Unique Channels</div>
            </div>
            <div class="stat-card">
                <div class="stat-value">{{ discovery_stats.videos_this_week }}</div>
                <div class="stat-label">New This Week</div>
            </div>
            <div class="stat-card">
                <div class="stat-value">{{ discovery_stats.videos_this_month }}</div>
                <div class="stat-label">New This Month</div>
            </div>
        </div>

        <!-- Top Artists -->
        <h3 style="margin-top: 20px;">Top Artists</h3>
        {% set artist_items = [] %}
        {% for artist in discovery_stats.top_artists[:15] %}
            {% set _ = artist_items.append({
                'primary': artist.artist,
                'secondary': artist.video_count ~ ' videos',
                'value': artist.total_plays ~ ' plays'
            }) %}
        {% endfor %}
        {{ components.list_card('', artist_items) }}

        <!-- Recently Discovered -->
        <h3 style="margin-top: 20px;">Recently Discovered Videos</h3>
        {% set discovered_items = [] %}
        {% for video in discovery_stats.recent_discoveries[:10] %}
            {% set _ = discovered_items.append({
                'primary': video.title,
                'secondary': video.artist ~ ' ‚Ä¢ ' ~ video.first_played,
                'value': 'üëç' if video.rating == 1 else ('üëé' if video.rating == -1 else '‚Äî')
            }) %}
        {% endfor %}
        {{ components.list_card('', discovered_items) }}

        <!-- Genre/Tag Cloud (if available) -->
        {% if discovery_stats.tag_cloud %}
        <h3 style="margin-top: 20px;">Popular Tags</h3>
        <div class="tag-cloud">
            {% for tag in discovery_stats.tag_cloud[:20] %}
            <span class="tag" style="font-size: {{ 0.8 + (tag.weight * 0.8) }}em;">
                {{ tag.name }} ({{ tag.count }})
            </span>
            {% endfor %}
        </div>
        {% endif %}
    </div>

    {% endif %}
</div>
{% endblock %}

{% block scripts %}
<script>
// Add any stats-specific JavaScript here
document.addEventListener('DOMContentLoaded', function() {
    // Auto-refresh countdown timer (optional)
    let refreshTime = 300; // 5 minutes in seconds
    const updateTimer = () => {
        refreshTime--;
        if (refreshTime <= 0) {
            location.reload();
        }
    };
    setInterval(updateTimer, 1000);
});
</script>
{% endblock %}