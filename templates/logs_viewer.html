<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>YouTube Thumbs - Logs</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #f5f7fa;
            min-height: 100vh;
            padding: 10px;
            margin: 0;
        }

        .container {
            max-width: 100%;
            margin: 0;
        }

        header {
            background: white;
            padding: 6px 12px;
            border-radius: 4px;
            margin-bottom: 8px;
            box-shadow: 0 1px 2px rgba(0,0,0,0.05);
            border-left: 2px solid #2563eb;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 8px;
        }

        .header-left {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        h1 {
            color: #1e293b;
            font-size: 0.95em;
            font-weight: 600;
            margin: 0;
        }

        .nav-links {
            display: flex;
            gap: 4px;
            flex-wrap: wrap;
        }

        .nav-links a {
            color: #475569;
            text-decoration: none;
            font-size: 0.7em;
            padding: 3px 8px;
            border-radius: 3px;
            background: #f1f5f9;
            border: 1px solid #e2e8f0;
            transition: all 0.2s;
        }

        .nav-links a.active {
            background: #2563eb;
            color: white;
            border-color: #2563eb;
        }

        .nav-links a:hover {
            background: #2563eb;
            color: white;
            border-color: #2563eb;
        }

        .card {
            background: white;
            padding: 15px;
            border-radius: 6px;
            box-shadow: 0 1px 2px rgba(0,0,0,0.05);
            margin-bottom: 10px;
        }

        .tab-navigation {
            display: flex;
            gap: 6px;
            margin-bottom: 15px;
            border-bottom: 1px solid #e5e7eb;
            padding-bottom: 6px;
        }

        .tab-button {
            padding: 6px 14px;
            border: none;
            border-radius: 4px 4px 0 0;
            background: #f8fafc;
            color: #475569;
            font-size: 0.8em;
            font-weight: 500;
            cursor: pointer;
            text-decoration: none;
            transition: all 0.2s;
        }

        .tab-button:hover {
            background: #e0f2fe;
            color: #0369a1;
        }

        .tab-button.active {
            background: #2563eb;
            color: white;
        }

        .filters {
            display: flex;
            gap: 10px;
            align-items: center;
            flex-wrap: wrap;
            margin-bottom: 15px;
            padding: 10px;
            background: #f8fafc;
            border-radius: 4px;
        }

        .filter-group {
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .filter-group label {
            font-size: 0.75em;
            color: #475569;
            font-weight: 500;
        }

        .filter-group select {
            padding: 4px 8px;
            border: 1px solid #d1d5db;
            border-radius: 3px;
            font-size: 0.75em;
            background: white;
            color: #334155;
            cursor: pointer;
        }

        .filter-group select:focus {
            outline: none;
            border-color: #2563eb;
            box-shadow: 0 0 0 2px rgba(37, 99, 235, 0.1);
        }

        .apply-btn {
            padding: 4px 12px;
            background: #2563eb;
            color: white;
            border: none;
            border-radius: 3px;
            cursor: pointer;
            font-weight: 500;
            font-size: 0.75em;
            transition: background 0.2s;
        }

        .apply-btn:hover {
            background: #1d4ed8;
        }

        .info-text {
            color: #64748b;
            font-size: 0.75em;
            margin-bottom: 10px;
        }

        .table-container {
            overflow-x: auto;
            margin-bottom: 10px;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.75em;
        }

        thead {
            background: #f8fafc;
            border-bottom: 2px solid #e5e7eb;
        }

        thead th {
            padding: 8px 10px;
            text-align: left;
            font-weight: 600;
            color: #475569;
            white-space: nowrap;
        }

        tbody tr {
            border-bottom: 1px solid #e5e7eb;
            transition: background-color 0.1s;
        }

        tbody tr:nth-child(even) {
            background-color: #f9fafb;
        }

        tbody tr:nth-child(odd) {
            background-color: white;
        }

        tbody tr:hover {
            background-color: #e0f2fe !important;
        }

        tbody td {
            padding: 8px 10px;
            vertical-align: top;
            color: #334155;
        }

        tbody td a {
            color: #2563eb;
            text-decoration: none;
        }

        tbody td a:hover {
            text-decoration: underline;
        }

        .badge {
            display: inline-block;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 0.85em;
            font-weight: 500;
        }

        .badge-like {
            background: #d1fae5;
            color: #065f46;
        }

        .badge-dislike {
            background: #fee2e2;
            color: #991b1b;
        }

        .badge-error {
            background: #fee2e2;
            color: #991b1b;
        }

        .badge-warning {
            background: #fef3c7;
            color: #92400e;
        }

        .badge-info {
            background: #dbeafe;
            color: #1e40af;
        }

        .badge-count {
            background: #e0e7ff;
            color: #3730a3;
        }

        .time-ago {
            color: #64748b;
            font-size: 0.9em;
        }

        .expand-btn {
            background: none;
            border: none;
            color: #2563eb;
            cursor: pointer;
            font-size: 1.2em;
            padding: 0 5px;
            transition: transform 0.2s;
        }

        .expand-btn:hover {
            color: #1d4ed8;
        }

        .expand-btn.expanded {
            transform: rotate(90deg);
        }

        .match-details {
            display: none;
            padding: 15px;
            background: #f8fafc;
            border-left: 3px solid #2563eb;
            margin: 5px 0;
        }

        .match-details.expanded {
            display: block;
        }

        .detail-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 15px;
        }

        .detail-section {
            background: white;
            padding: 10px;
            border-radius: 4px;
        }

        .detail-section h4 {
            color: #1e293b;
            font-size: 0.85em;
            margin-bottom: 8px;
            font-weight: 600;
        }

        .detail-row {
            display: flex;
            justify-content: space-between;
            padding: 4px 0;
            font-size: 0.85em;
        }

        .detail-label {
            color: #64748b;
            font-weight: 500;
        }

        .detail-value {
            color: #334155;
        }

        .quality-good {
            color: #059669;
            font-weight: 500;
        }

        .quality-fair {
            color: #d97706;
            font-weight: 500;
        }

        .error-message {
            font-family: 'Courier New', monospace;
            background: #f1f5f9;
            padding: 8px;
            border-radius: 3px;
            font-size: 0.9em;
            word-break: break-word;
        }

        .error-full {
            display: none;
        }

        .error-full.expanded {
            display: block;
        }

        .show-more {
            color: #2563eb;
            cursor: pointer;
            text-decoration: underline;
            font-size: 0.85em;
        }

        .show-more:hover {
            color: #1d4ed8;
        }

        .pagination {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 5px;
            margin-top: 15px;
            flex-wrap: wrap;
        }

        .pagination a, .pagination button {
            padding: 5px 10px;
            border: 1px solid #d1d5db;
            background: white;
            color: #475569;
            border-radius: 4px;
            cursor: pointer;
            font-weight: 500;
            font-size: 0.75em;
            transition: all 0.2s;
            text-decoration: none;
            display: inline-block;
            min-width: 30px;
            text-align: center;
        }

        .pagination a:hover, .pagination button:hover:not(:disabled) {
            background: #2563eb;
            color: white;
            border-color: #2563eb;
        }

        .pagination button:disabled {
            opacity: 0.4;
            cursor: not-allowed;
            background: #f9fafb;
        }

        .pagination .current-page {
            background: #2563eb;
            color: white;
            border-color: #2563eb;
            font-weight: 600;
        }

        .pagination .ellipsis {
            border: none;
            background: none;
            cursor: default;
            color: #94a3b8;
        }

        .empty-state {
            text-align: center;
            padding: 40px 20px;
            color: #64748b;
        }

        .empty-state-icon {
            font-size: 3em;
            margin-bottom: 15px;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
            gap: 10px;
        }

        .stat-card {
            background: white;
            padding: 15px;
            border-radius: 6px;
            box-shadow: 0 1px 2px rgba(0,0,0,0.05);
            text-align: center;
        }

        .data-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.75em;
        }

        .log-entry {
            background: white;
            padding: 12px;
            border-radius: 4px;
            margin-bottom: 8px;
            box-shadow: 0 1px 2px rgba(0,0,0,0.05);
        }

        .log-level {
            display: inline-block;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 0.85em;
            font-weight: 500;
        }

        .log-level.error {
            background: #fee2e2;
            color: #991b1b;
        }

        .log-level.warning {
            background: #fef3c7;
            color: #92400e;
        }

        .log-level.info {
            background: #dbeafe;
            color: #1e40af;
        }

        .log-level.debug {
            background: #f3f4f6;
            color: #4b5563;
        }

        .log-message {
            margin-top: 8px;
            font-size: 0.8em;
            color: #334155;
        }

        .log-text {
            font-family: 'Courier New', monospace;
            background: #f1f5f9;
            padding: 8px;
            border-radius: 3px;
            word-break: break-word;
        }

        .log-full {
            display: none;
            font-family: 'Courier New', monospace;
            background: #f1f5f9;
            padding: 8px;
            border-radius: 3px;
            word-break: break-word;
            margin-top: 8px;
        }

        .log-full.expanded {
            display: block;
        }

        .show-more-btn {
            background: none;
            border: none;
            color: #2563eb;
            cursor: pointer;
            text-decoration: underline;
            font-size: 0.85em;
            padding: 4px 0;
            margin-top: 4px;
        }

        .show-more-btn:hover {
            color: #1d4ed8;
        }

        .empty-icon {
            font-size: 3em;
            margin-bottom: 15px;
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <div class="header-left">
                <h1>YouTube Thumbs Rating</h1>
                <div class="nav-links">
                    <a href="{{ ingress_path }}/?tab=tests">Tests</a>
                    <a href="{{ ingress_path }}/?tab=rating">Bulk Rating</a>
                    <a href="{{ ingress_path }}/stats">Stats</a>
                    <a href="{{ ingress_path }}/data">Database</a>
                    <a href="{{ ingress_path }}/logs" class="active">Logs</a>
                    <a href="{{ ingress_path }}/database">DB Admin</a>
                </div>
            </div>
        </header>

        <div class="card">
            <!-- Tab Navigation -->
            <div class="tab-navigation">
                <a href="{{ ingress_path }}/logs?tab=rated" class="tab-button {{ 'active' if current_tab == 'rated' else '' }}">
                    Rated Songs
                </a>
                <a href="{{ ingress_path }}/logs?tab=matches" class="tab-button {{ 'active' if current_tab == 'matches' else '' }}">
                    Matches
                </a>
                <a href="{{ ingress_path }}/logs?tab=recent" class="tab-button {{ 'active' if current_tab == 'recent' else '' }}">
                    Recent
                </a>
                <a href="{{ ingress_path }}/logs?tab=errors" class="tab-button {{ 'active' if current_tab == 'errors' else '' }}">
                    Errors
                </a>
                <a href="{{ ingress_path }}/logs?tab=quota_prober" class="tab-button {{ 'active' if current_tab == 'quota_prober' else '' }}">
                    Quota Prober
                </a>
            </div>

            <!-- Rated Songs Tab -->
            {% if current_tab == 'rated' %}
            <form method="GET" action="{{ ingress_path }}/logs">
                <input type="hidden" name="tab" value="rated">
                <div class="filters">
                    <div class="filter-group">
                        <label for="period">Time Period:</label>
                        <select name="period" id="period">
                            <option value="hour" {{ 'selected' if period_filter == 'hour' else '' }}>Last Hour</option>
                            <option value="day" {{ 'selected' if period_filter == 'day' else '' }}>Last Day</option>
                            <option value="week" {{ 'selected' if period_filter == 'week' else '' }}>Last Week</option>
                            <option value="month" {{ 'selected' if period_filter == 'month' else '' }}>Last Month</option>
                            <option value="all" {{ 'selected' if period_filter == 'all' else '' }}>All Time</option>
                        </select>
                    </div>
                    <div class="filter-group">
                        <label for="rating">Rating Type:</label>
                        <select name="rating" id="rating">
                            <option value="all" {{ 'selected' if rating_filter == 'all' else '' }}>All</option>
                            <option value="like" {{ 'selected' if rating_filter == 'like' else '' }}>Likes</option>
                            <option value="dislike" {{ 'selected' if rating_filter == 'dislike' else '' }}>Dislikes</option>
                        </select>
                    </div>
                    <button type="submit" class="apply-btn">Apply</button>
                </div>
            </form>

            <p class="info-text">
                {{ total_count }} rated songs ‚Ä¢ Page {{ page }}/{{ total_pages }}
            </p>

            {% if songs %}
            <div class="table-container">
                <table>
                    <thead>
                        <tr>
                            <th>Time</th>
                            <th>Song</th>
                            <th>Artist</th>
                            <th>Rating</th>
                            <th>Plays</th>
                            <th>Video ID</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for song in songs %}
                        <tr>
                            <td><span class="time-ago">{{ song.time_ago }}</span></td>
                            <td>{{ song.title }}</td>
                            <td>{{ song.artist }}</td>
                            <td>
                                {% if song.rating == 'like' %}
                                    <span class="badge badge-like">üëç Like</span>
                                {% elif song.rating == 'dislike' %}
                                    <span class="badge badge-dislike">üëé Dislike</span>
                                {% endif %}
                            </td>
                            <td><span class="badge badge-count">{{ song.play_count }}</span></td>
                            <td>
                                <a href="https://youtube.com/watch?v={{ song.yt_video_id }}" target="_blank">{{ song.yt_video_id }}</a>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
            {% else %}
            <div class="empty-state">
                <div class="empty-state-icon">üì≠</div>
                <h3>No rated songs found</h3>
                <p>Try adjusting your filters</p>
            </div>
            {% endif %}
            {% endif %}

            <!-- Matches Tab -->
            {% if current_tab == 'matches' %}
            <form method="GET" action="{{ ingress_path }}/logs">
                <input type="hidden" name="tab" value="matches">
                <div class="filters">
                    <div class="filter-group">
                        <label for="period">Time Period:</label>
                        <select name="period" id="period">
                            <option value="hour" {{ 'selected' if period_filter == 'hour' else '' }}>Last Hour</option>
                            <option value="day" {{ 'selected' if period_filter == 'day' else '' }}>Last Day</option>
                            <option value="week" {{ 'selected' if period_filter == 'week' else '' }}>Last Week</option>
                            <option value="month" {{ 'selected' if period_filter == 'month' else '' }}>Last Month</option>
                            <option value="all" {{ 'selected' if period_filter == 'all' else '' }}>All Time</option>
                        </select>
                    </div>
                    <button type="submit" class="apply-btn">Apply</button>
                </div>
            </form>

            <p class="info-text">
                {{ total_count }} matches ‚Ä¢ Page {{ page }}/{{ total_pages }}
            </p>

            {% if matches %}
            <div class="table-container">
                <table>
                    <thead>
                        <tr>
                            <th style="width: 30px;"></th>
                            <th>Time</th>
                            <th>HA Song</th>
                            <th>Matched To (YouTube)</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for match in matches %}
                        <tr>
                            <td>
                                <button class="expand-btn" onclick="toggleMatch('{{ match.yt_video_id }}')">‚ñ∂</button>
                            </td>
                            <td><span class="time-ago">{{ match.time_ago }}</span></td>
                            <td>{{ match.ha_title }} <em style="color: #64748b;">by {{ match.ha_artist }}</em></td>
                            <td>{{ match.yt_title }} <em style="color: #64748b;">by {{ match.yt_channel }}</em></td>
                        </tr>
                        <tr>
                            <td colspan="4" style="padding: 0;">
                                <div class="match-details" id="match-{{ match.yt_video_id }}">
                                    <div class="detail-grid">
                                        <div class="detail-section">
                                            <h4>üè† Home Assistant Info</h4>
                                            <div class="detail-row">
                                                <span class="detail-label">Title:</span>
                                                <span class="detail-value">{{ match.ha_title }}</span>
                                            </div>
                                            <div class="detail-row">
                                                <span class="detail-label">Artist:</span>
                                                <span class="detail-value">{{ match.ha_artist }}</span>
                                            </div>
                                            <div class="detail-row">
                                                <span class="detail-label">Duration:</span>
                                                <span class="detail-value">{{ match.ha_duration }}s</span>
                                            </div>
                                        </div>

                                        <div class="detail-section">
                                            <h4>‚ñ∂Ô∏è YouTube Match</h4>
                                            <div class="detail-row">
                                                <span class="detail-label">Title:</span>
                                                <span class="detail-value">{{ match.yt_title }}</span>
                                            </div>
                                            <div class="detail-row">
                                                <span class="detail-label">Channel:</span>
                                                <span class="detail-value">{{ match.yt_channel }}</span>
                                            </div>
                                            <div class="detail-row">
                                                <span class="detail-label">Duration:</span>
                                                <span class="detail-value">{{ match.yt_duration }}s</span>
                                            </div>
                                            <div class="detail-row">
                                                <span class="detail-label">Video ID:</span>
                                                <span class="detail-value">
                                                    <a href="https://youtube.com/watch?v={{ match.yt_video_id }}" target="_blank">{{ match.yt_video_id }}</a>
                                                </span>
                                            </div>
                                        </div>

                                        <div class="detail-section">
                                            <h4>‚ú® Match Quality</h4>
                                            <div class="detail-row">
                                                <span class="detail-label">Duration Diff:</span>
                                                <span class="detail-value {{ 'quality-good' if match.match_quality == 'good' else 'quality-fair' }}">
                                                    {% if match.duration_diff > 0 %}+{% endif %}{{ match.duration_diff }}s
                                                    {% if match.match_quality == 'good' %}‚úì{% endif %}
                                                </span>
                                            </div>
                                            <div class="detail-row">
                                                <span class="detail-label">Attempts:</span>
                                                <span class="detail-value">{{ match.match_attempts }}</span>
                                            </div>
                                            <div class="detail-row">
                                                <span class="detail-label">Popularity:</span>
                                                <span class="detail-value">{{ match.play_count }} plays</span>
                                            </div>
                                            <div class="detail-row">
                                                <span class="detail-label">Matched:</span>
                                                <span class="detail-value">{{ match.timestamp }}</span>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
            {% else %}
            <div class="empty-state">
                <div class="empty-state-icon">üîç</div>
                <h3>No matches found</h3>
                <p>Try adjusting your filters</p>
            </div>
            {% endif %}
            {% endif %}

            <!-- Errors Tab -->
            {% if current_tab == 'errors' %}
            <form method="GET" action="{{ ingress_path }}/logs">
                <input type="hidden" name="tab" value="errors">
                <div class="filters">
                    <div class="filter-group">
                        <label for="period">Time Period:</label>
                        <select name="period" id="period">
                            <option value="hour" {{ 'selected' if period_filter == 'hour' else '' }}>Last Hour</option>
                            <option value="day" {{ 'selected' if period_filter == 'day' else '' }}>Last Day</option>
                            <option value="week" {{ 'selected' if period_filter == 'week' else '' }}>Last Week</option>
                            <option value="month" {{ 'selected' if period_filter == 'month' else '' }}>Last Month</option>
                            <option value="all" {{ 'selected' if period_filter == 'all' else '' }}>All Time</option>
                        </select>
                    </div>
                    <div class="filter-group">
                        <label for="level">Level:</label>
                        <select name="level" id="level">
                            <option value="all" {{ 'selected' if level_filter == 'all' else '' }}>All</option>
                            <option value="ERROR" {{ 'selected' if level_filter == 'ERROR' else '' }}>ERROR</option>
                            <option value="WARNING" {{ 'selected' if level_filter == 'WARNING' else '' }}>WARNING</option>
                            <option value="INFO" {{ 'selected' if level_filter == 'INFO' else '' }}>INFO</option>
                        </select>
                    </div>
                    <button type="submit" class="apply-btn">Apply</button>
                </div>
            </form>

            {% if log_error %}
            <div style="padding: 10px; background: #fee2e2; color: #991b1b; border-radius: 4px; margin-bottom: 10px;">
                {{ log_error }}
            </div>
            {% endif %}

            <p class="info-text">
                {{ total_count }} errors ‚Ä¢ Page {{ page }}/{{ total_pages }}
            </p>

            {% if errors %}
            <div class="table-container">
                <table>
                    <thead>
                        <tr>
                            <th>Time</th>
                            <th>Level</th>
                            <th>Message</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for error in errors %}
                        <tr>
                            <td><span class="time-ago">{{ error.time_ago }}</span></td>
                            <td>
                                <span class="badge badge-{{ error.level|lower }}">{{ error.level }}</span>
                            </td>
                            <td>
                                <div class="error-message">
                                    <div class="error-short">{{ error.display_message }}</div>
                                    {% if error.truncated %}
                                    <div class="error-full" id="error-{{ loop.index }}">{{ error.message }}</div>
                                    <span class="show-more" onclick="toggleError({{ loop.index }})">Show more</span>
                                    {% endif %}
                                </div>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
            {% else %}
            <div class="empty-state">
                <div class="empty-state-icon">‚úì</div>
                <h3>No errors found</h3>
                <p>System is running smoothly!</p>
            </div>
            {% endif %}
            {% endif %}

            <!-- Pagination -->
            {% if total_pages > 0 %}
            <div class="pagination">
                {% if page > 1 %}
                    <a href="{{ ingress_path }}/logs?tab={{ current_tab }}&page={{ page - 1 }}&period={{ period_filter }}{% if current_tab == 'rated' %}&rating={{ rating_filter }}{% endif %}{% if current_tab == 'errors' %}&level={{ level_filter }}{% endif %}">‚Üê Prev</a>
                {% else %}
                    <button disabled>‚Üê Prev</button>
                {% endif %}

                {% for page_num in page_numbers %}
                    {% if page_num == '...' %}
                        <span class="ellipsis">...</span>
                    {% elif page_num == page %}
                        <span class="current-page">{{ page_num }}</span>
                    {% else %}
                        <a href="{{ ingress_path }}/logs?tab={{ current_tab }}&page={{ page_num }}&period={{ period_filter }}{% if current_tab == 'rated' %}&rating={{ rating_filter }}{% endif %}{% if current_tab == 'errors' %}&level={{ level_filter }}{% endif %}">{{ page_num }}</a>
                    {% endif %}
                {% endfor %}

                {% if page < total_pages %}
                    <a href="{{ ingress_path }}/logs?tab={{ current_tab }}&page={{ page + 1 }}&period={{ period_filter }}{% if current_tab == 'rated' %}&rating={{ rating_filter }}{% endif %}{% if current_tab == 'errors' %}&level={{ level_filter }}{% endif %}">Next ‚Üí</a>
                {% else %}
                    <button disabled>Next ‚Üí</button>
                {% endif %}
            </div>
            {% endif %}

            <!-- Quota Prober Tab -->
            {% if current_tab == 'quota_prober' %}
            <form method="GET" action="{{ ingress_path }}/logs">
                <input type="hidden" name="tab" value="quota_prober">
                <input type="hidden" name="page" value="1">

                <div class="filters">
                    <div class="filter-group">
                        <label>Time Period</label>
                        <select name="period" onchange="this.form.submit()">
                            <option value="hour" {{ 'selected' if period_filter == 'hour' else '' }}>Last Hour</option>
                            <option value="day" {{ 'selected' if period_filter == 'day' else '' }}>Last 24 Hours</option>
                            <option value="week" {{ 'selected' if period_filter == 'week' else '' }}>Last Week</option>
                            <option value="month" {{ 'selected' if period_filter == 'month' else '' }}>Last Month</option>
                            <option value="all" {{ 'selected' if period_filter == 'all' else '' }}>All Time</option>
                        </select>
                    </div>

                    <div class="filter-group">
                        <label>Event Type</label>
                        <select name="event" onchange="this.form.submit()">
                            <option value="all" {{ 'selected' if event_filter == 'all' else '' }}>All Events</option>
                            <option value="probe" {{ 'selected' if event_filter == 'probe' else '' }}>Probes</option>
                            <option value="retry" {{ 'selected' if event_filter == 'retry' else '' }}>Retries</option>
                            <option value="success" {{ 'selected' if event_filter == 'success' else '' }}>Successes</option>
                            <option value="error" {{ 'selected' if event_filter == 'error' else '' }}>Errors</option>
                            <option value="recovery" {{ 'selected' if event_filter == 'recovery' else '' }}>Recoveries</option>
                        </select>
                    </div>

                    <div class="filter-group">
                        <label>Log Level</label>
                        <select name="level" onchange="this.form.submit()">
                            <option value="all" {{ 'selected' if level_filter == 'all' else '' }}>All Levels</option>
                            <option value="INFO" {{ 'selected' if level_filter == 'INFO' else '' }}>INFO</option>
                            <option value="WARNING" {{ 'selected' if level_filter == 'WARNING' else '' }}>WARNING</option>
                            <option value="ERROR" {{ 'selected' if level_filter == 'ERROR' else '' }}>ERROR</option>
                            <option value="DEBUG" {{ 'selected' if level_filter == 'DEBUG' else '' }}>DEBUG</option>
                        </select>
                    </div>
                </div>
            </form>

            <!-- Summary Statistics -->
            {% if quota_prober_stats %}
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(140px, 1fr)); gap: 10px; margin: 15px 0; padding: 10px; background: #f8fafc; border-radius: 4px;">
                <div style="text-align: center;">
                    <div style="font-size: 0.7em; color: #64748b; margin-bottom: 4px;">Probe Attempts</div>
                    <div style="font-size: 1.3em; font-weight: 700; color: #2563eb;">{{ quota_prober_stats.probes }}</div>
                </div>
                <div style="text-align: center;">
                    <div style="font-size: 0.7em; color: #64748b; margin-bottom: 4px;">Recoveries</div>
                    <div style="font-size: 1.3em; font-weight: 700; color: #8b5cf6;">{{ quota_prober_stats.recoveries }}</div>
                </div>
                <div style="text-align: center;">
                    <div style="font-size: 0.7em; color: #64748b; margin-bottom: 4px;">Retry Batches</div>
                    <div style="font-size: 1.3em; font-weight: 700; color: #f59e0b;">{{ quota_prober_stats.retries }}</div>
                </div>
                <div style="text-align: center;">
                    <div style="font-size: 0.7em; color: #64748b; margin-bottom: 4px;">Videos Resolved</div>
                    <div style="font-size: 1.3em; font-weight: 700; color: #10b981;">{{ quota_prober_stats.resolved }}</div>
                </div>
            </div>
            {% endif %}

            <div style="color: #64748b; font-size: 0.8em; margin-bottom: 10px;">
                Showing {{ quota_prober_logs|length }} of {{ total_count }} logs
            </div>

            <!-- Quota Prober Logs List -->
            {% if quota_prober_logs %}
                {% for log in quota_prober_logs %}
                <div class="log-entry" style="border-left: 3px solid {% if log.event_type == 'probe' %}#2563eb{% elif log.event_type == 'retry' %}#f59e0b{% elif log.event_type == 'success' %}#10b981{% elif log.event_type == 'error' %}#ef4444{% elif log.event_type == 'recovery' %}#8b5cf6{% else %}#94a3b8{% endif %};">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 4px;">
                        <div style="display: flex; align-items: center; gap: 8px;">
                            <span style="font-size: 1.1em;">{% if log.event_type == 'probe' %}üîç{% elif log.event_type == 'retry' %}üîÑ{% elif log.event_type == 'success' %}‚úÖ{% elif log.event_type == 'error' %}‚ùå{% elif log.event_type == 'recovery' %}üéâ{% else %}üìù{% endif %}</span>
                            <span class="log-level {{ log.level.lower() }}">{{ log.level }}</span>
                            <span style="font-size: 0.75em; color: #64748b;">{{ log.time_ago }}</span>
                        </div>
                        <span style="font-size: 0.7em; color: #94a3b8;">{{ log.timestamp }}</span>
                    </div>

                    <div class="log-message">
                        <div class="log-text">{{ log.display_message }}</div>
                        {% if log.truncated %}
                        <div id="quota-log-{{ loop.index }}" class="log-full">
                            {{ log.message }}
                        </div>
                        <button class="show-more-btn" onclick="toggleQuotaLog({{ loop.index }})">Show more</button>
                        {% endif %}
                    </div>
                </div>
                {% endfor %}
            {% else %}
                <div style="text-align: center; padding: 40px; color: #64748b;">
                    <div style="font-size: 2em; margin-bottom: 10px;">üîç</div>
                    <div style="font-size: 0.9em;">No quota prober logs found for the selected filters</div>
                </div>
            {% endif %}

            <!-- Pagination -->
            {% if total_pages > 0 %}
            <div class="pagination">
                {% if page > 1 %}
                    <a href="{{ ingress_path }}/logs?tab=quota_prober&page={{ page - 1 }}&period={{ period_filter }}&event={{ event_filter }}&level={{ level_filter }}">‚Üê Previous</a>
                {% else %}
                    <button disabled>‚Üê Previous</button>
                {% endif %}

                {% for page_num in page_numbers %}
                    {% if page_num == '...' %}
                        <span style="padding: 0 5px; color: #94a3b8;">...</span>
                    {% elif page_num == page %}
                        <span style="padding: 5px 10px; background: #2563eb; color: white; border-radius: 4px; font-weight: 600;">{{ page_num }}</span>
                    {% else %}
                        <a href="{{ ingress_path }}/logs?tab=quota_prober&page={{ page_num }}&period={{ period_filter }}&event={{ event_filter }}&level={{ level_filter }}">{{ page_num }}</a>
                    {% endif %}
                {% endfor %}

                {% if page < total_pages %}
                    <a href="{{ ingress_path }}/logs?tab=quota_prober&page={{ page + 1 }}&period={{ period_filter }}&event={{ event_filter }}&level={{ level_filter }}">Next ‚Üí</a>
                {% else %}
                    <button disabled>Next ‚Üí</button>
                {% endif %}
            </div>
            {% endif %}
            {% endif %}

            <!-- Recent Videos Tab -->
            {% if current_tab == 'recent' %}
            <div class="stats-grid" style="margin-bottom: 1em;">
                <div class="stat-card">
                    <div style="font-size: 0.75em; color: #64748b; margin-bottom: 0.3em;">Recently Added</div>
                    <div style="font-size: 1.3em; font-weight: 700; color: #2563eb;">{{ total_count }}</div>
                </div>
            </div>

            {% if recent_videos %}
            <div class="table-container">
                <table class="data-table">
                    <thead>
                        <tr>
                            <th style="width: 25%;">Title</th>
                            <th style="width: 15%;">Artist</th>
                            <th style="width: 20%;">Channel</th>
                            <th style="width: 15%;">Date Added</th>
                            <th style="width: 10%;">Rating</th>
                            <th style="width: 10%;">Plays</th>
                            <th style="width: 5%;">Link</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for video in recent_videos %}
                        <tr>
                            <td>
                                <div style="font-weight: 500;">{{ video.ha_title or video.yt_title or 'Unknown' }}</div>
                                {% if video.yt_match_pending %}
                                <div style="font-size: 0.75em; color: #f59e0b; margin-top: 0.2em;">
                                    ‚è≥ Pending: {{ video.pending_reason or 'Unknown' }}
                                </div>
                                {% endif %}
                            </td>
                            <td>{{ video.ha_artist or '-' }}</td>
                            <td>{{ video.yt_channel or '-' }}</td>
                            <td style="white-space: nowrap;">
                                {% if video.date_added %}
                                    {{ video.date_added[:10] }}<br>
                                    <span style="font-size: 0.8em; color: #64748b;">{{ video.date_added[11:19] }}</span>
                                {% else %}
                                    -
                                {% endif %}
                            </td>
                            <td>
                                {% if video.rating == 'like' %}
                                    <span style="color: #10b981;">üëç Like</span>
                                {% elif video.rating == 'dislike' %}
                                    <span style="color: #ef4444;">üëé Dislike</span>
                                {% else %}
                                    <span style="color: #94a3b8;">- None</span>
                                {% endif %}
                            </td>
                            <td style="text-align: center;">{{ video.play_count or 0 }}</td>
                            <td style="text-align: center;">
                                {% if video.yt_url %}
                                <a href="{{ video.yt_url }}" target="_blank" style="color: #2563eb; text-decoration: none; font-size: 1.2em;" title="Watch on YouTube">üîó</a>
                                {% else %}
                                -
                                {% endif %}
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
            {% else %}
            <div class="empty-state">
                <div class="empty-icon">üì≠</div>
                <h3>No Videos Yet</h3>
                <p>No videos have been added to the database yet.</p>
            </div>
            {% endif %}
            {% endif %}
        </div>
    </div>

    <script>
        // Toggle match details accordion
        function toggleMatch(videoId) {
            const detailsDiv = document.getElementById('match-' + videoId);
            const button = event.target;

            if (detailsDiv.classList.contains('expanded')) {
                detailsDiv.classList.remove('expanded');
                button.classList.remove('expanded');
            } else {
                detailsDiv.classList.add('expanded');
                button.classList.add('expanded');
            }
        }

        // Toggle error message full text
        function toggleError(index) {
            const fullDiv = document.getElementById('error-' + index);
            const button = event.target;

            if (fullDiv.classList.contains('expanded')) {
                fullDiv.classList.remove('expanded');
                button.textContent = 'Show more';
            } else {
                fullDiv.classList.add('expanded');
                button.textContent = 'Show less';
            }
        }

        // Toggle quota prober log message full text
        function toggleQuotaLog(index) {
            const fullDiv = document.getElementById('quota-log-' + index);
            const button = event.target;

            if (fullDiv.classList.contains('expanded')) {
                fullDiv.classList.remove('expanded');
                button.textContent = 'Show more';
            } else {
                fullDiv.classList.add('expanded');
                button.textContent = 'Show less';
            }
        }
    </script>
</body>
</html>
