<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>YouTube Thumbs - Database Viewer</title>
    <link rel="stylesheet" href="{{ static_url('css/common.css') }}">
</head>
<body>
    <div class="container">
        <header>
            <div class="header-left">
                <h1>YouTube Thumbs Rating</h1>
                <div class="nav-links">
                    <a href="{{ ingress_path }}/?tab=tests">Tests</a>
                    <a href="{{ ingress_path }}/?tab=rating">Bulk Rating</a>
                    <a href="{{ ingress_path }}/stats">Stats</a>
                    <a href="{{ ingress_path }}/data" class="active">Database</a>
                    
                    <!-- Logs dropdown menu -->
                    <div class="nav-dropdown">
                        <div class="nav-dropdown-btn">
                            Logs <span class="dropdown-arrow">▼</span>
                        </div>
                        <div class="nav-dropdown-content">
                            <a href="{{ ingress_path }}/logs?tab=rated">Rated Songs</a>
                            <a href="{{ ingress_path }}/logs?tab=matches">Matches</a>
                            <a href="{{ ingress_path }}/logs?tab=recent">Recent</a>
                            <a href="{{ ingress_path }}/logs?tab=errors">Errors</a>
                            <a href="{{ ingress_path }}/logs/api-calls">API Calls</a>
                            <a href="{{ ingress_path }}/logs/pending-ratings">Queue</a>
                        </div>
                    </div>
                    
                    <a href="{{ ingress_path }}/database">DB Admin</a>
                </div>
            </div>
            <form method="GET" action="{{ ingress_path }}/data" style="margin: 0;">
                <details style="margin: 0;">
                    <summary>⚙️ Columns ({{ selected_columns|length }})</summary>
                    <div class="details-content">
                        <div class="column-selector">
                            {% for col_key, col_name in all_columns.items() %}
                            <div class="column-option">
                                <input type="checkbox"
                                       id="col_{{ col_key }}"
                                       name="column"
                                       value="{{ col_key }}"
                                       {% if col_key in selected_columns %}checked{% endif %}>
                                <label for="col_{{ col_key }}">{{ col_name }}</label>
                            </div>
                            {% endfor %}
                        </div>
                        <div style="margin-top: 10px;">
                            <button type="submit" class="apply-btn">Apply</button>
                        </div>
                    </div>
                </details>
            </form>
        </header>

        <div class="card">
            <p class="info-text">
                {{ total_count }} records • Page {{ page }}/{{ total_pages }} • Sort: <strong>{{ all_columns[sort_by] }}</strong> {{ '▼' if sort_order == 'DESC' else '▲' }} • <em>Click headers to sort, column widths and selection are auto-saved</em>
                <br><small style="color: #94a3b8;">Tip: Use <code style="background: #f1f5f9; padding: 2px 6px; border-radius: 2px;">?reset-columns=true</code> to reset column preferences to defaults</small>
            </p>

            <div class="table-container">
                <table>
                    <thead>
                        <tr>
                            {% for col in selected_columns %}
                            <th data-column="{{ col }}">
                                <a href="{{ ingress_path }}/data?sort={{ col }}&order={% if sort_by == col and sort_order == 'DESC' %}ASC{% else %}DESC{% endif %}&columns={{ columns_param }}">
                                    {{ all_columns[col] }}
                                    {% if sort_by == col %}
                                        <span class="sort-indicator">{{ '▼' if sort_order == 'DESC' else '▲' }}</span>
                                    {% endif %}
                                </a>
                                <div class="resize-handle"></div>
                            </th>
                            {% endfor %}
                        </tr>
                    </thead>
                    <tbody>
                        {% for row in rows %}
                        <tr>
                            {% for col in selected_columns %}
                            <td>
                                {% if row.get(col + '_link') %}
                                    <a href="{{ row[col] }}" target="_blank">{{ row[col] }}</a>
                                {% else %}
                                    {{ row[col] }}
                                {% endif %}
                            </td>
                            {% endfor %}
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>

            <!-- Pagination -->
            <div class="pagination">
                {% if page > 1 %}
                    <a href="{{ ingress_path }}/data?page={{ page - 1 }}&sort={{ sort_by }}&order={{ sort_order }}&columns={{ columns_param }}">← Prev</a>
                {% else %}
                    <button disabled>← Prev</button>
                {% endif %}

                {% for page_num in page_numbers %}
                    {% if page_num == '...' %}
                        <span class="ellipsis">...</span>
                    {% elif page_num == page %}
                        <span class="current-page">{{ page_num }}</span>
                    {% else %}
                        <a href="{{ ingress_path }}/data?page={{ page_num }}&sort={{ sort_by }}&order={{ sort_order }}&columns={{ columns_param }}">{{ page_num }}</a>
                    {% endif %}
                {% endfor %}

                {% if page < total_pages %}
                    <a href="{{ ingress_path }}/data?page={{ page + 1 }}&sort={{ sort_by }}&order={{ sort_order }}&columns={{ columns_param }}">Next →</a>
                {% else %}
                    <button disabled>Next →</button>
                {% endif %}
            </div>
        </div>
    </div>

    <script>
        // Column resizing and state persistence functionality
        // ========================================================================
        // STORAGE BEHAVIOR NOTE:
        // Column preferences (widths and enabled/disabled state) are stored in the
        // browser's localStorage. This means:
        //
        // 1. PERSISTENCE: Preferences are saved across browser sessions
        // 2. PER-BROWSER: Each browser/device maintains its own preferences
        // 3. PER-ORIGIN: localStorage is scoped to the addon's origin (secure)
        // 4. MULTI-USER: If multiple users share the same device/browser,
        //    they will see the same column preferences
        //
        // To reset preferences, use: ?reset-columns=true
        // To override with URL params, pass ?column=field1&column=field2
        // ========================================================================
        (function() {
            const widthStorageKey = 'db_viewer_column_widths';
            const columnsStorageKey = 'db_viewer_enabled_columns';
            let currentHandle = null;
            let currentColumn = null;
            let startX = 0;
            let startWidth = 0;

            // Get all valid column values from the current page
            function getValidColumns() {
                const validColumns = new Set();
                document.querySelectorAll('input[name="column"]').forEach(checkbox => {
                    validColumns.add(checkbox.value);
                });
                return validColumns;
            }

            // Validate stored columns against current schema
            function validateStoredColumns(enabledColumns) {
                const validColumns = getValidColumns();
                // Filter out any columns that no longer exist in the schema
                return enabledColumns.filter(col => validColumns.has(col));
            }

            // Load saved column selection from localStorage
            function loadColumnSelection() {
                try {
                    const urlParams = new URLSearchParams(window.location.search);

                    // Check for explicit reset parameter (?reset-columns=true)
                    if (urlParams.get('reset-columns') === 'true') {
                        // User explicitly requested reset - don't apply saved preferences
                        return;
                    }

                    // Only apply saved preferences if URL doesn't have column parameters
                    if (!urlParams.has('column')) {
                        const saved = localStorage.getItem(columnsStorageKey);
                        if (saved) {
                            try {
                                let enabledColumns = JSON.parse(saved);

                                // Validate stored columns against current schema
                                enabledColumns = validateStoredColumns(enabledColumns);

                                // Apply valid stored preferences
                                if (enabledColumns.length > 0) {
                                    document.querySelectorAll('input[name="column"]').forEach(checkbox => {
                                        checkbox.checked = enabledColumns.includes(checkbox.value);
                                    });
                                }
                            } catch (parseError) {
                                console.warn('Stored column preferences are corrupted, clearing:', parseError);
                                // Clear corrupted data
                                localStorage.removeItem(columnsStorageKey);
                            }
                        }
                    }
                } catch (e) {
                    console.error('Error loading column selection:', e);
                }
            }

            // Save column selection to localStorage
            function saveColumnSelection() {
                try {
                    const enabledColumns = [];
                    document.querySelectorAll('input[name="column"]:checked').forEach(checkbox => {
                        enabledColumns.push(checkbox.value);
                    });
                    localStorage.setItem(columnsStorageKey, JSON.stringify(enabledColumns));
                } catch (e) {
                    console.error('Error saving column selection:', e);
                    // Provide user feedback for storage errors
                    if (e.name === 'QuotaExceededError') {
                        alert('Unable to save column preferences: browser storage is full. Please clear some data or use private/incognito mode.');
                    }
                }
            }

            // Load saved column widths from localStorage
            function loadColumnWidths() {
                try {
                    const saved = localStorage.getItem(widthStorageKey);
                    if (saved) {
                        const widths = JSON.parse(saved);
                        Object.keys(widths).forEach(colKey => {
                            const th = document.querySelector(`th[data-column="${colKey}"]`);
                            if (th) {
                                th.style.width = widths[colKey] + 'px';
                                th.style.minWidth = widths[colKey] + 'px';
                            }
                        });
                    }
                } catch (e) {
                    console.error('Error loading column widths:', e);
                }
            }

            // Save column widths to localStorage
            function saveColumnWidths() {
                try {
                    const widths = {};
                    document.querySelectorAll('th[data-column]').forEach(th => {
                        const colKey = th.getAttribute('data-column');
                        if (colKey) {
                            widths[colKey] = th.offsetWidth;
                        }
                    });
                    localStorage.setItem(widthStorageKey, JSON.stringify(widths));
                } catch (e) {
                    console.error('Error saving column widths:', e);
                }
            }

            // Handle mouse down on resize handle
            function onMouseDown(e) {
                e.preventDefault();
                e.stopPropagation();

                currentHandle = e.target;
                currentColumn = currentHandle.parentElement;
                startX = e.pageX;
                startWidth = currentColumn.offsetWidth;

                currentColumn.classList.add('resizing');
                document.body.style.cursor = 'col-resize';
                document.body.style.userSelect = 'none';

                document.addEventListener('mousemove', onMouseMove);
                document.addEventListener('mouseup', onMouseUp);
            }

            // Handle mouse move during resize
            function onMouseMove(e) {
                if (!currentColumn) return;

                const diff = e.pageX - startX;
                const newWidth = Math.max(50, startWidth + diff); // Minimum 50px

                currentColumn.style.width = newWidth + 'px';
                currentColumn.style.minWidth = newWidth + 'px';
            }

            // Handle mouse up after resize
            function onMouseUp(e) {
                if (currentColumn) {
                    currentColumn.classList.remove('resizing');
                    saveColumnWidths();
                }

                currentHandle = null;
                currentColumn = null;
                document.body.style.cursor = '';
                document.body.style.userSelect = '';

                document.removeEventListener('mousemove', onMouseMove);
                document.removeEventListener('mouseup', onMouseUp);
            }

            // Initialize resize handles
            function initResizeHandles() {
                const handles = document.querySelectorAll('.resize-handle');
                handles.forEach(handle => {
                    handle.addEventListener('mousedown', onMouseDown);
                });
            }

            // Initialize column checkbox event listeners
            function initColumnCheckboxes() {
                document.querySelectorAll('input[name="column"]').forEach(checkbox => {
                    checkbox.addEventListener('change', saveColumnSelection);
                });
            }

            // Initialize Apply button to also save and auto-submit with saved columns
            function initApplyButton() {
                const form = document.querySelector('form[action*="/data"]');
                if (form) {
                    form.addEventListener('submit', function(e) {
                        saveColumnSelection();
                    });
                }
            }

            // Initialize on page load
            loadColumnSelection();
            loadColumnWidths();
            initResizeHandles();
            initColumnCheckboxes();
            initApplyButton();
        })();
    </script>
</body>
</html>
