<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>YouTube Thumbs - Categories & Duration</title>
    <meta http-equiv="refresh" content="300"> <!-- Auto-refresh every 5 minutes -->
    <link rel="stylesheet" href="{{ static_url('css/common.css') }}">
    <link rel="stylesheet" href="{{ static_url('css/stats_visualizations.css') }}">
</head>
<body>
    <div class="container">
        <header>
            <div class="header-left">
                <h1>YouTube Thumbs Rating</h1>
                <div class="nav-links">
                    <a href="{{ ingress_path }}/?tab=tests">Tests</a>
                    <a href="{{ ingress_path }}/?tab=rating">Bulk Rating</a>
                    <a href="{{ ingress_path }}/stats">Stats</a>
                    <a href="{{ ingress_path }}/data">Database</a>
                    
                    <!-- Logs dropdown menu -->
                    <div class="nav-dropdown">
                        <div class="nav-dropdown-btn">
                            Logs <span class="dropdown-arrow">‚ñº</span>
                        </div>
                        <div class="nav-dropdown-content">
                            <a href="{{ ingress_path }}/logs?tab=rated">Rated Songs</a>
                            <a href="{{ ingress_path }}/logs?tab=matches">Matches</a>
                            <a href="{{ ingress_path }}/logs?tab=recent">Recent</a>
                            <a href="{{ ingress_path }}/logs?tab=errors">Errors</a>
                            <a href="{{ ingress_path }}/logs/api-calls">API Calls</a>
                            <a href="{{ ingress_path }}/logs/pending-ratings">Queue</a>
                        </div>
                    </div>
                    
                    <a href="{{ ingress_path }}/database">DB Admin</a>
                </div>
            </div>
            <div style="font-size: 0.65em; color: #64748b;">Auto-refresh: 5min</div>
        </header>

        <!-- Tab Navigation -->
        <div class="stats-tabs">
            <a href="{{ ingress_path }}/stats" class="{{ 'active' if current_tab == 'overview' }}">üìä Overview</a>
            <a href="{{ ingress_path }}/stats/analytics" class="{{ 'active' if current_tab == 'analytics' }}">üìà Analytics</a>
            <a href="{{ ingress_path }}/stats/api" class="{{ 'active' if current_tab == 'api' }}">üîß API & Queue</a>
            <a href="{{ ingress_path }}/stats/categories" class="{{ 'active' if current_tab == 'categories' }}">üìÅ Categories</a>
            <a href="{{ ingress_path }}/stats/discovery" class="{{ 'active' if current_tab == 'discovery' }}">üîç Discovery</a>
        </div>

        <!-- Category Breakdown -->
        {% if category_breakdown %}
        <div class="card">
            <h2>üìÅ Video Categories</h2>
            <p class="text-muted mb-3">Distribution of videos by YouTube category</p>
            
            <div class="bar-chart">
                {% for category in category_breakdown %}
                <div class="bar-row">
                    <div class="bar-label">{{ category.category_name }}</div>
                    <div class="bar-container">
                        <div class="bar-fill" style="width: {{ category.percentage }}%">
                            {{ category.count }} videos ({{ "%.1f"|format(category.percentage) }}%)
                        </div>
                    </div>
                </div>
                {% endfor %}
            </div>
        </div>
        {% endif %}

        <!-- Duration Analysis -->
        {% if duration_analysis %}
        <div class="card">
            <h2>‚è±Ô∏è Video Duration Preferences</h2>
            <p class="text-muted mb-3">Analysis of your listening habits by video length</p>
            
            <div class="stat-cards-grid">
                {% for duration_bucket in duration_analysis %}
                <div class="stat-card">
                    <div class="stat-value">{{ duration_bucket.count }}</div>
                    <div class="stat-label">{{ duration_bucket.duration_bucket }}</div>
                    <div class="stat-sublabel">
                        {{ "%.1f"|format(duration_bucket.avg_plays) }} avg plays ‚Ä¢ 
                        {{ duration_bucket.likes }} likes
                    </div>
                </div>
                {% endfor %}
            </div>
            
            <div class="mt-4">
                <h3>üìä Duration Distribution</h3>
                {% set total_duration_videos = duration_analysis | sum(attribute='count') %}
                <div class="bar-chart">
                    {% for duration_bucket in duration_analysis %}
                    {% set percentage = (duration_bucket.count / total_duration_videos * 100) if total_duration_videos > 0 else 0 %}
                    <div class="bar-row">
                        <div class="bar-label">{{ duration_bucket.duration_bucket }}</div>
                        <div class="bar-container">
                            <div class="bar-fill" style="width: {{ percentage }}%">
                                {{ duration_bucket.count }} videos ({{ "%.1f"|format(percentage) }}%)
                            </div>
                        </div>
                    </div>
                    {% endfor %}
                </div>
            </div>
        </div>
        {% endif %}

        <!-- Duration Insights -->
        {% if duration_analysis %}
        <div class="card">
            <h2>üí° Duration Insights</h2>
            
            {% set most_videos_bucket = duration_analysis | sort(attribute='count', reverse=true) | first %}
            {% set highest_engagement = duration_analysis | sort(attribute='avg_plays', reverse=true) | first %}
            {% set most_liked_bucket = duration_analysis | sort(attribute='likes', reverse=true) | first %}
            
            <div class="stat-cards-grid">
                {% if most_videos_bucket %}
                <div class="stat-card">
                    <div class="stat-value">{{ most_videos_bucket.duration_bucket }}</div>
                    <div class="stat-label">Most Common Length</div>
                    <div class="stat-sublabel">{{ most_videos_bucket.count }} videos in your collection</div>
                </div>
                {% endif %}
                
                {% if highest_engagement %}
                <div class="stat-card">
                    <div class="stat-value">{{ highest_engagement.duration_bucket }}</div>
                    <div class="stat-label">Most Replayed</div>
                    <div class="stat-sublabel">{{ "%.1f"|format(highest_engagement.avg_plays) }} average plays</div>
                </div>
                {% endif %}
                
                {% if most_liked_bucket %}
                <div class="stat-card">
                    <div class="stat-value">{{ most_liked_bucket.duration_bucket }}</div>
                    <div class="stat-label">Most Liked Length</div>
                    <div class="stat-sublabel">{{ most_liked_bucket.likes }} total likes</div>
                </div>
                {% endif %}
                
                {% set engagement_efficiency = duration_analysis | map('engagement_ratio') | list %}
                {% for bucket in duration_analysis %}
                {% set engagement_ratio = (bucket.likes / bucket.count) if bucket.count > 0 else 0 %}
                {% if loop.first or engagement_ratio > max_ratio %}
                {% set max_ratio = engagement_ratio %}
                {% set best_ratio_bucket = bucket %}
                {% endif %}
                {% endfor %}
                
                {% if best_ratio_bucket is defined %}
                <div class="stat-card">
                    <div class="stat-value">{{ best_ratio_bucket.duration_bucket }}</div>
                    <div class="stat-label">Best Like Ratio</div>
                    <div class="stat-sublabel">{{ "%.1f"|format((best_ratio_bucket.likes / best_ratio_bucket.count * 100) if best_ratio_bucket.count > 0 else 0) }}% liked</div>
                </div>
                {% endif %}
            </div>
        </div>
        {% endif %}

        <!-- Category Performance -->
        {% if category_breakdown %}
        <div class="card">
            <h2>üèÜ Category Performance</h2>
            <p class="text-muted mb-3">Most popular categories in your collection</p>
            
            <table class="comparison-table">
                <thead>
                    <tr>
                        <th>Category</th>
                        <th class="number">Videos</th>
                        <th class="number">Percentage</th>
                        <th>Popularity</th>
                    </tr>
                </thead>
                <tbody>
                    {% for category in category_breakdown %}
                    <tr>
                        <td>{{ category.category_name }}</td>
                        <td class="number font-semibold">{{ category.count }}</td>
                        <td class="number">{{ "%.1f"|format(category.percentage) }}%</td>
                        <td>
                            <div class="progress-bar" style="width: 100px;">
                                <div class="progress-fill" style="width: {{ category.percentage }}%"></div>
                            </div>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        {% endif %}

        <!-- Recommendations Based on Analysis -->
        <div class="card">
            <h2>üí° Recommendations</h2>
            <div class="stat-cards-grid">
                {% if duration_analysis %}
                {% set total_likes = duration_analysis | sum(attribute='likes') %}
                {% set total_videos_all = duration_analysis | sum(attribute='count') %}
                {% set overall_like_rate = (total_likes / total_videos_all * 100) if total_videos_all > 0 else 0 %}
                
                <div class="stat-card">
                    <div class="stat-value">{{ "%.1f"|format(overall_like_rate) }}%</div>
                    <div class="stat-label">Overall Like Rate</div>
                    <div class="stat-sublabel">{{ total_likes }} likes out of {{ total_videos_all }} videos</div>
                </div>
                {% endif %}
                
                {% if category_breakdown and category_breakdown|length > 0 %}
                {% set dominant_category = category_breakdown[0] %}
                <div class="stat-card">
                    <div class="stat-value">{{ dominant_category.category_name }}</div>
                    <div class="stat-label">Dominant Category</div>
                    <div class="stat-sublabel">{{ "%.1f"|format(dominant_category.percentage) }}% of your videos</div>
                </div>
                {% endif %}
                
                <div class="stat-card">
                    <div class="stat-value">Explore</div>
                    <div class="stat-label">Recommendation</div>
                    <div class="stat-sublabel">
                        {% if highest_engagement is defined %}
                        Try more {{ highest_engagement.duration_bucket }} videos for best replay value
                        {% else %}
                        Diversify your collection with different video lengths
                        {% endif %}
                    </div>
                </div>
                
                <div class="stat-card">
                    <div class="stat-value">Optimize</div>
                    <div class="stat-label">Suggestion</div>
                    <div class="stat-sublabel">
                        {% if category_breakdown and category_breakdown|length < 3 %}
                        Explore more categories to diversify your music taste
                        {% else %}
                        Your music taste is well-diversified across categories
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>

        <div style="text-align: center; color: #64748b; font-size: 0.8em; margin-top: 20px; padding: 10px;">
            <em>Generated at {{ generated_at }}</em>
        </div>
    </div>
</body>
</html>