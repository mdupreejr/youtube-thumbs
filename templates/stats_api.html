<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>YouTube Thumbs - API & Queue</title>
    <meta http-equiv="refresh" content="300"> <!-- Auto-refresh every 5 minutes -->
    <link rel="stylesheet" href="{{ static_url('css/common.css') }}">
    <link rel="stylesheet" href="{{ static_url('css/stats_visualizations.css') }}">
</head>
<body>
    <div class="container">
        <header>
            <div class="header-left">
                <h1>YouTube Thumbs Rating</h1>
                <div class="nav-links">
                    <a href="{{ ingress_path }}/?tab=tests">Tests</a>
                    <a href="{{ ingress_path }}/?tab=rating">Bulk Rating</a>
                    <a href="{{ ingress_path }}/stats">Stats</a>
                    <a href="{{ ingress_path }}/data">Database</a>
                    
                    <!-- Logs dropdown menu -->
                    <div class="nav-dropdown">
                        <div class="nav-dropdown-btn">
                            Logs <span class="dropdown-arrow">‚ñº</span>
                        </div>
                        <div class="nav-dropdown-content">
                            <a href="{{ ingress_path }}/logs?tab=rated">Rated Songs</a>
                            <a href="{{ ingress_path }}/logs?tab=matches">Matches</a>
                            <a href="{{ ingress_path }}/logs?tab=recent">Recent</a>
                            <a href="{{ ingress_path }}/logs?tab=errors">Errors</a>
                            <a href="{{ ingress_path }}/logs/api-calls">API Calls</a>
                            <a href="{{ ingress_path }}/logs/pending-ratings">Queue</a>
                        </div>
                    </div>
                    
                    <a href="{{ ingress_path }}/database">DB Admin</a>
                </div>
            </div>
            <div style="font-size: 0.65em; color: #64748b;">Auto-refresh: 5min</div>
        </header>

        <!-- Tab Navigation -->
        <div class="stats-tabs">
            <a href="{{ ingress_path }}/stats" class="{{ 'active' if current_tab == 'overview' }}">üìä Overview</a>
            <a href="{{ ingress_path }}/stats/analytics" class="{{ 'active' if current_tab == 'analytics' }}">üìà Analytics</a>
            <a href="{{ ingress_path }}/stats/api" class="{{ 'active' if current_tab == 'api' }}">üîß API & Queue</a>
            <a href="{{ ingress_path }}/stats/categories" class="{{ 'active' if current_tab == 'categories' }}">üìÅ Categories</a>
            <a href="{{ ingress_path }}/stats/discovery" class="{{ 'active' if current_tab == 'discovery' }}">üîç Discovery</a>
        </div>

        <!-- API Quota Summary -->
        {% if api_summary %}
        <div class="card">
            <h2>üìä API Quota Usage (Last 30 Days)</h2>
            <div class="stat-cards-grid">
                <div class="stat-card">
                    <div class="stat-value">{{ api_summary.total_calls or 0 }}</div>
                    <div class="stat-label">Total API Calls</div>
                    <div class="stat-sublabel">{{ api_summary.period_days or 30 }} days</div>
                </div>
                
                {% if api_summary.daily_stats %}
                <div class="stat-card">
                    <div class="stat-value">{{ (api_summary.total_calls / api_summary.period_days) | round(1) if api_summary.period_days > 0 else 0 }}</div>
                    <div class="stat-label">Avg Daily Usage</div>
                    <div class="stat-sublabel">calls per day</div>
                </div>
                
                <div class="stat-card">
                    <div class="stat-value">{{ api_summary.daily_stats[-1].calls if api_summary.daily_stats else 0 }}</div>
                    <div class="stat-label">Today's Usage</div>
                    <div class="stat-sublabel">{{ (api_summary.daily_stats[-1].calls / 10000 * 100) | round(1) if api_summary.daily_stats else 0 }}% of daily limit</div>
                </div>
                {% endif %}
                
                <div class="stat-card">
                    <div class="stat-value">{{ ((10000 - (api_summary.daily_stats[-1].calls if api_summary.daily_stats else 0)) / 10000 * 100) | round(1) if api_summary.daily_stats else 100 }}%</div>
                    <div class="stat-label">Quota Remaining</div>
                    <div class="stat-sublabel">{{ 10000 - (api_summary.daily_stats[-1].calls if api_summary.daily_stats else 0) }} calls left</div>
                </div>
            </div>
            
            {% if api_summary.daily_stats %}
            <div class="mt-4">
                <h3>üìà Daily Usage Trend</h3>
                <div class="sparkline-container">
                    <div class="sparkline">
                        {% for day in api_summary.daily_stats[-14:] %}
                        <div class="spark-bar" 
                             style="height: {{ (day.calls / 10000 * 100) if day.calls else 0 }}%"
                             data-value="{{ day.calls }} ({{ day.date }})"
                             title="{{ day.date }}: {{ day.calls }} calls"></div>
                        {% endfor %}
                    </div>
                </div>
                <div class="text-center text-small text-muted">Last 14 days (hover for details)</div>
            </div>
            {% endif %}
        </div>
        {% endif %}

        <!-- Today's Hourly Usage -->
        {% if hourly_usage %}
        <div class="card">
            <h2>‚è∞ Today's Hourly API Usage</h2>
            <p class="text-muted mb-3">Quota consumption by hour (10,000 daily limit)</p>
            
            <div class="bar-chart">
                {% for hour_data in hourly_usage %}
                {% set quota_percent = (hour_data.calls / 10000 * 100) if hour_data.calls else 0 %}
                {% set bar_color = 'bar-success' if quota_percent < 5 else ('bar-warning' if quota_percent < 10 else 'bar-danger') %}
                <div class="bar-row">
                    <div class="bar-label">{{ "%02d"|format(hour_data.hour) }}:00</div>
                    <div class="bar-container">
                        <div class="bar-fill {{ bar_color }}" style="width: {{ quota_percent }}%">
                            {{ hour_data.calls }} calls
                        </div>
                    </div>
                </div>
                {% endfor %}
            </div>
        </div>
        {% endif %}

        <!-- API Call Breakdown -->
        {% if api_calls %}
        <div class="card">
            <h2>üîç API Call Breakdown (Last 24h)</h2>
            
            <table class="comparison-table">
                <thead>
                    <tr>
                        <th>API Method</th>
                        <th class="number">Calls</th>
                        <th class="number">Quota Used</th>
                        <th class="number">Success Rate</th>
                    </tr>
                </thead>
                <tbody>
                    {% for call in api_calls %}
                    <tr>
                        <td>{{ call.api_method or 'Unknown' }}</td>
                        <td class="number">{{ call.call_count or 0 }}</td>
                        <td class="number">{{ call.quota_used or 0 }}</td>
                        <td class="number">{{ "%.1f"|format(call.success_rate or 0) }}%</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        {% endif %}

        <!-- Queue Health Dashboard -->
        {% if queue_stats %}
        <div class="card">
            <h2>‚ö° Queue Health Dashboard</h2>
            
            <div class="stat-cards-grid">
                <div class="stat-card">
                    <div class="stat-value">{{ queue_stats.pending_count or 0 }}</div>
                    <div class="stat-label">Pending Items</div>
                    <div class="stat-sublabel">
                        <span class="status-indicator status-pending">
                            <span class="status-dot"></span>
                            Waiting
                        </span>
                    </div>
                </div>
                
                <div class="stat-card">
                    <div class="stat-value">{{ queue_stats.processing_count or 0 }}</div>
                    <div class="stat-label">Processing</div>
                    <div class="stat-sublabel">
                        <span class="status-indicator status-processing">
                            <span class="status-dot"></span>
                            Active
                        </span>
                    </div>
                </div>
                
                <div class="stat-card">
                    <div class="stat-value">{{ queue_stats.failed_count or 0 }}</div>
                    <div class="stat-label">Failed Items</div>
                    <div class="stat-sublabel">
                        <span class="status-indicator status-failed">
                            <span class="status-dot"></span>
                            Needs attention
                        </span>
                    </div>
                </div>
                
                <div class="stat-card">
                    <div class="stat-value">{{ "%.1f"|format(queue_stats.success_rate or 0) }}%</div>
                    <div class="stat-label">Success Rate</div>
                    <div class="stat-sublabel">Overall queue performance</div>
                </div>
            </div>
            
            {% if queue_stats.success_rate is defined %}
            <div class="mt-4">
                <h3>Queue Performance</h3>
                <div class="progress-bar">
                    {% set rate = queue_stats.success_rate or 0 %}
                    {% set progress_class = 'progress-danger' if rate < 70 else ('progress-warning' if rate < 90 else '') %}
                    <div class="progress-fill {{ progress_class }}" style="width: {{ rate }}%"></div>
                </div>
                <div class="text-center text-small text-muted mt-1">{{ "%.1f"|format(rate) }}% success rate</div>
            </div>
            {% endif %}
        </div>
        {% endif %}

        <!-- Recent Queue Activity -->
        {% if queue_activity %}
        <div class="card">
            <h2>üìã Recent Queue Activity</h2>
            
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px;">
                <!-- Recent Ratings -->
                <div>
                    <h3>üëçüëé Recent Ratings</h3>
                    {% for item in queue_activity[:10] if item.type == 'rating' %}
                    <div class="list-item">
                        <div class="item-info">
                            <div class="item-title text-small">
                                {{ item.payload.title if item.payload and item.payload.title else 'Unknown' }}
                            </div>
                            <div class="item-meta text-small">
                                <span class="status-indicator status-{{ item.status }}">
                                    <span class="status-dot"></span>
                                    {{ item.status }}
                                </span>
                                ‚Ä¢ {{ item.attempts }} attempts
                            </div>
                        </div>
                    </div>
                    {% else %}
                    <p class="text-muted text-small">No recent rating activity</p>
                    {% endfor %}
                </div>
                
                <!-- Recent Searches -->
                <div>
                    <h3>üîç Recent Searches</h3>
                    {% for item in queue_activity[:10] if item.type == 'search' %}
                    <div class="list-item">
                        <div class="item-info">
                            <div class="item-title text-small">
                                {{ item.payload.query if item.payload and item.payload.query else 'Unknown search' }}
                            </div>
                            <div class="item-meta text-small">
                                <span class="status-indicator status-{{ item.status }}">
                                    <span class="status-dot"></span>
                                    {{ item.status }}
                                </span>
                                ‚Ä¢ {{ item.attempts }} attempts
                            </div>
                        </div>
                    </div>
                    {% else %}
                    <p class="text-muted text-small">No recent search activity</p>
                    {% endfor %}
                </div>
            </div>
        </div>
        {% endif %}

        <!-- Queue Errors -->
        {% if queue_errors and queue_errors|length > 0 %}
        <div class="card">
            <h2>‚ùå Recent Queue Errors</h2>
            <p class="text-muted mb-3">Failed items that may need attention</p>
            
            {% for error in queue_errors %}
            <div class="list-item" style="border-left: 3px solid #ef4444;">
                <div class="item-info">
                    <div class="item-title text-small">
                        {{ error.payload.title or error.payload.query if error.payload else 'Unknown item' }}
                    </div>
                    <div class="item-meta text-small">
                        <strong>Error:</strong> {{ error.last_error or 'Unknown error' }}
                    </div>
                    <div class="item-meta text-small text-muted">
                        Attempted {{ error.attempts }} times ‚Ä¢ Last attempt: {{ error.last_attempt }}
                    </div>
                </div>
            </div>
            {% endfor %}
        </div>
        {% endif %}

        <div style="text-align: center; color: #64748b; font-size: 0.8em; margin-top: 20px; padding: 10px;">
            <em>Generated at {{ generated_at }}</em>
        </div>
    </div>
</body>
</html>