# Installation Guide

## Prerequisites

Before installing, you need:
- Home Assistant OS or Supervised installation
- YouTube OAuth credentials (`credentials.json` from Google Cloud Console)
  → The app will automatically generate `token.pickle` on first run
- Your media player entity ID (e.g., `media_player.apple_tv`)

## Getting YouTube OAuth Credentials

1. Go to [Google Cloud Console](https://console.cloud.google.com/)
2. Create a new project or select an existing one
3. Enable **YouTube Data API v3**:
   - Go to **APIs & Services** → **Enable APIs and Services**
   - Search for "YouTube Data API v3" and enable it
4. Create OAuth credentials:
   - Go to **Credentials** → **Create Credentials** → **OAuth 2.0 Client ID**
   - If prompted, configure the OAuth consent screen first (just fill in required fields)
   - Choose **Desktop app** as the application type
   - Name it (e.g., "YouTube Thumbs Home Assistant")
5. Download the credentials:
   - Click the download button next to your new OAuth client
   - Save the file as `credentials.json`

**Note:** The add-on will handle the OAuth authentication flow automatically when it first runs with your `credentials.json` file. All credentials live under `/addon_configs/XXXXXXXX_youtube_thumbs/` on the host (mounted as `/config/youtube_thumbs/` inside the container); no other paths are checked.

## Installation Steps

### 1. Add Repository to Home Assistant

1. Under Settings -> Addons -> Click triple dots in top right corner and add repository.
2. Add this repository URL:
   ```
   https://github.com/mdupreejr/youtube-thumbs
   ```
2. Find **"YouTube Thumbs Rating"** in the available add-ons

### 3. Copy OAuth Credentials

Before starting the add-on, copy your OAuth credentials:

1. Via **File Editor** or **Samba share**, navigate to:
   ```
   /addon_configs/XXXXXXXX_youtube_thumbs/
   ```
   (XXXXXXXX will be a random string generated by Home Assistant)

2. Copy `credentials.json` to this directory (the add-on sees this as `/config/youtube_thumbs/`). The `XXXXXXXX` portion is the unique 8-character ID Home Assistant assigns to this add-on; you can find it by opening the add-on in the UI and clicking the **File Editor** shortcut (or by browsing the `addon_configs` share via Samba).
   - The app will automatically create `token.pickle` when it first authenticates

**Samba path**: `\\homeassistant.local\addon_configs\XXXXXXXX_youtube_thumbs\`

### 4. Configure the Add-on

1. In the Add-ons section, click on **YouTube Thumbs*
2. Go to the **Configuration** tab
3. Fill in the required fields:

```yaml
media_player_entity: media_player.apple_tv
port: 21812
rate_limit_per_minute: 10   # Max YouTube API calls in any 60-second window
rate_limit_per_hour: 100    # Max YouTube API calls in any 3600-second window
rate_limit_per_day: 500     # Max YouTube API calls in any 24-hour period
log_level: INFO
```

**Note:** The add-on automatically uses the Supervisor token for authentication, and connects to Home Assistant via `http://supervisor/core` (no configuration needed).

Need sqlite_web outside of Home Assistant ingress? Add

```yaml
sqlite_web_host: 0.0.0.0  # exposes the DB UI to your LAN
sqlite_web_port: 8080     # optional, defaults to 8080
```

Only open the DB UI to networks you trust.

Leaving `sqlite_web_host` at the default (`127.0.0.1`) means the **OPEN WEB UI**
button will route through Home Assistant ingress automatically. If you override the
host, skip the button and browse directly to `http://<home-assistant-host>:<sqlite_web_port>`.

If Google reports `quotaExceeded`, the add-on writes
`/config/youtube_thumbs/quota_guard.json` and pauses all YouTube API traffic for
24 hours (tweak with `YTT_QUOTA_COOLDOWN_SECONDS`). During that cooldown the HTTP
API returns `503` responses and the history tracker skips new matches.

**Security note:** The rating API always listens on `127.0.0.1` and cannot be exposed. The sqlite_web helper also defaults to `127.0.0.1`, but you can set `sqlite_web_host: 0.0.0.0` (and optionally adjust `sqlite_web_port`) if you intentionally want the DB UI reachable from your LAN.

#### Finding your media player entity:
1. Go to **Developer Tools** → **States**
2. Search for your AppleTV (e.g., `media_player.apple_tv`)
3. Copy the **exact entity ID** and paste it in the `media_player_entity` field

### 5. Start the Add-on

### 6. Verify It's Running

1. Go to the **Log** tab
2. Check for successful startup messages:
   ```
   [INFO] Starting YouTube Thumbs service on 127.0.0.1:21812...
   [INFO] Home Assistant URL: http://supervisor/core
   [INFO] Media Player Entity: media_player.apple_tv
   ```
3. If you see OAuth credential warnings, verify you copied the files to the correct location

### 6b. Access the sqlite_web UI (optional)

- Open the **YouTube Thumbs Rating** add-on page in Home Assistant and click **OPEN WEB UI**; it will launch sqlite_web in a new browser tab.
- Logs for the UI are stored in `/config/youtube_thumbs/sqlite_web.log`.
- Need a different binding? Set `sqlite_web_host` (defaults to `127.0.0.1`) and `sqlite_web_port` or export the `SQLITE_WEB_HOST` / `SQLITE_WEB_PORT` env vars. Only expose the DB UI to networks you trust, and use a direct browser tab (`http://<home-assistant-host>:<sqlite_web_port>`) when you override the host.

### 7. Configure Home Assistant

Add REST commands to your `configuration.yaml`:

1. Go to **Settings** → **Add-ons** → **File Editor** (or use your preferred editor)
2. Open `configuration.yaml`
3. Add this configuration:

```yaml
rest_command:
  youtube_thumbs_up:
    url: "http://localhost:21812/thumbs_up"
    method: POST
    timeout: 30
    
  youtube_thumbs_down:
    url: "http://localhost:21812/thumbs_down"
    method: POST
    timeout: 30
```

4. Save the file
5. Go to **Developer Tools** → **YAML** → **Check Configuration** -> **Restart**

### 8. Test the Integration

1. Start playing music on youtube on AppleTV
2. Go to **Developer Tools** → **Services**
3. Search for `rest_command.youtube_thumbs_up`
4. Click **CALL SERVICE**
5. Check the add-on logs (Settings → Add-ons → YouTube Thumbs Rating → Log tab)
6. You should see a success message with the video that was rated

### 9. Create Automations (Optional)

Example for Lutron remote buttons:

```yaml
automation:
  - alias: "Music - Thumbs Up"
    trigger:
      - platform: device
        device_id: YOUR_LUTRON_DEVICE_ID
        type: press
        subtype: button_1
    action:
      - service: rest_command.youtube_thumbs_up

  - alias: "Music - Thumbs Down"
    trigger:
      - platform: device
        device_id: YOUR_LUTRON_DEVICE_ID
        type: press
        subtype: button_2
    action:
      - service: rest_command.youtube_thumbs_down
```

## Troubleshooting

### Add-on won't start
- Check logs for specific error messages
- Verify media player entity ID is correct

### "No media currently playing" error
- Make sure music is actually playing on your AppleTV and that it shows on your appletv device on hass.

### OAuth errors
- Verify `credentials.json` is from Google Cloud Console with YouTube Data API v3 enabled
- If authentication fails, check the add-on logs for specific error messages
- Delete `token.pickle` and restart the add-on to re-authenticate if needed

### Can't find the add-on in the store
- Try refreshing the Add-on Store page
- Check Settings → Add-ons → Add-on Store → ⋮ → Check for updates
- Restart Home Assistant if the add-on still doesn't appear

### Manually importing legacy `ratings.log`

If you have historical data in `/config/youtube_thumbs/ratings.log`, you can enter it manually (this is typically a one-time chore):

1. Stop the add-on so the SQLite file is unlocked.
2. Open `sqlite_web` (port 8080) or use the `sqlite3 /config/youtube_thumbs/ratings.db` CLI.
3. Create rows in the `video_ratings` table using the timestamps/video IDs from the log. Example SQL:

```sql
INSERT OR IGNORE INTO video_ratings (
  video_id, ha_title, yt_title, channel, rating, date_added, date_updated, play_count, rating_count
) VALUES (
  'ZmLIxKpgEPw', 'Song Title', 'Song Title', 'Artist', 'like',
  '2024-05-01 12:00:00', '2024-05-01 12:00:00', 1, 1
);
```

4. Restart the add-on; new ratings and plays will now append automatically.

## API Endpoints

### `POST /thumbs_up`
Rate the currently playing song as "like".

### `POST /thumbs_down`
Rate the currently playing song as "dislike".

### `GET /health`
Health check endpoint with rate limiter statistics.

Response example:
```json
{
  "status": "healthy",
  "rate_limiter": {
    "last_minute": 2,
    "last_hour": 15,
    "last_day": 47
  }
}
```

## Security Notes

- OAuth credentials are stored in `/addon_configs/` (persistent storage)
- The add-on uses the Supervisor token automatically (no manual token needed)
- Service only accessible from localhost (not exposed to network)
- Never share your `credentials.json` file with others
